#!/bin/bash
# Locate any lines in our notes that has an uncheck todo item

PAGER=""

cd ~/notes

printHelp() {
    cat << EOF
Usage: $0 [-p]
View all open action items from notes

-p		Display action items using a pager
EOF
}

getActionItems() {
(
ls *.md | while read file ; do
    headers=()
    headersPrinted=false
    headersPrintIdx=0
    grep -e "\[ \]" -e "\#" $file | while read line ; do
	prefix=$(echo "$line" | cut -d' ' -f1)
        if [ "$prefix" = "-" ] ; then
	    if [ "$headersPrinted" = false ] ; then
		if [ $headersPrintIdx == 0 ] ; then
		    echo
		fi

		for ((i=$headersPrintIdx; i<${#headers[@]}; i++)) ; do
		    if (( $i == 0 )) ; then
			echo "${headers[$i]} ($file)"
		    else
			echo ${headers[$i]}
		    fi
		done
		headersPrinted=true
		headersPrintIdx=${#headers[@]}
	    fi
	    echo $line
	else
	    if (( ${#prefix} > ${#headers[@]} )) ; then
		headers+=("$line")
		headersPrinted=false
	    else
		while (( ${#prefix} <= ${#headers[@]} )) ; do
		    unset headers[${#headers[@]}-1]
		done
		headersPrintIdx=${#headers[@]}
		headers+=("$line")
		headersPrinted=false
	    fi
	fi
    done
done
) | glow $PAGER -
}

while getopts "hp" option; do
    case "${option}" in
	h)
	    printHelp
	    exit 0
	    ;;
	p)
	    PAGER="-p"
	    ;;
	*)
	    echo "Unknown Option: ${option}"
	    printHelp
	    exit 1
	    ;;
    esac
done

getActionItems
